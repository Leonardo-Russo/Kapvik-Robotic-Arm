function [f5, n5] = Reaction(P_T, q_1, q_2, q_3, q_4, q_1d, q_2d, q_3d, q_4d, q_1dd, q_2dd, q_3dd, q_4dd)
g=3.71;
n4=[                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     q_2dd/600 + q_3dd/600 + q_4dd/600 + (cos(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/600 - (cos(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/600 - (q_2d + q_3d + q_4d)*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) - (sin(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/600 - (sin(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)) - sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) - (q_4d*cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (q_4d*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (q_4d*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 - (q_4d*sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             q_2dd/600 + q_3dd/600 + q_4dd/600 - (3*q_1d^2*cos(q_2)^2)/1000 + (cos(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/600 - (317*cos(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/100200 + (23*q_1dd*cos(q_2))/1000 + (q_2d + q_3d + q_4d)*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) - (317*sin(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/100200 - (sin(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/600 - (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) - (((11*q_2d)/25 + (11*q_3d)/25)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/20 - ((cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*((5*q_2d)/167 + (5*q_3d)/167 + (5*q_4d)/167))/20 - (317*q_4d*cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/100200 + (q_4d*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (q_4d*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 - (317*q_4d*sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/100200 + (11*q_1dd*cos(q_2)*cos(q_3))/500 - (11*q_1dd*sin(q_2)*sin(q_3))/500 - (q_1d*sin(q_2)*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50))/20 - (11*q_1d*q_3d*cos(q_2)*sin(q_3))/500 - (11*q_1d*q_3d*cos(q_3)*sin(q_2))/500;
(317*q_2dd)/100200 + (317*q_3dd)/100200 + (317*q_4dd)/100200 + (cos(q_4)*((11*q_2dd)/25 + (11*q_3dd)/25 + sin(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50)) + (q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + cos(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50)))/20 + (sin(q_4)*((q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + ((11*q_2d)/25 + (11*q_3d)/25)*(q_2d + q_3d) - sin(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50) + cos(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50))))/20 + (cos(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/600 - (cos(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/600 - (sin(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/600 - (sin(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) - (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)) - sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))*(q_2d/600 + q_3d/600 + q_4d/600 + (cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600) + ((cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*((5*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/167 - (5*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/167))/20 - (q_4d*cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 + (q_4d*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600 - (q_4d*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/600 - (q_4d*sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/600];



f4=[(167*sin(q_4)*((11*q_2dd)/25 + (11*q_3dd)/25 + sin(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50)) + (q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + cos(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50)))/100 - (167*cos(q_4)*((q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + ((11*q_2d)/25 + (11*q_3d)/25)*(q_2d + q_3d) - sin(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50) + cos(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50))))/100 - (167*(cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)) - sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))*((5*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/167 - (5*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/167))/100 - (167*(q_2d + q_3d + q_4d)*((5*q_2d)/167 + (5*q_3d)/167 + (5*q_4d)/167))/100;
                                             q_2dd/20 + q_3dd/20 + q_4dd/20 + (167*cos(q_4)*((11*q_2dd)/25 + (11*q_3dd)/25 + sin(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50)) + (q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + cos(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50)))/100 + (167*sin(q_4)*((q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3))*((11*q_1d*cos(q_2)*cos(q_3))/25 - (11*q_1d*sin(q_2)*sin(q_3))/25) + ((11*q_2d)/25 + (11*q_3d)/25)*(q_2d + q_3d) - sin(q_3)*((23*cos(q_2)*sin(q_2)*q_1d^2)/50 - (3*q_2d*cos(q_2)*q_1d)/50 + (23*q_2dd)/50 + g*cos(q_2) + (3*q_1dd*sin(q_2))/50) + cos(q_3)*((23*q_1d^2*cos(q_2)^2)/50 + (3*q_1dd*cos(q_2))/50 - g*sin(q_2) + q_2d*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50))))/100 + (167*(cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*((5*cos(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/167 - (5*sin(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/167))/100;
                                                                                                                                                                                                                                                         (501*q_1d^2*cos(q_2)^2)/5000 + (cos(q_4)*(q_1dd*sin(q_2)*sin(q_3) - q_1dd*cos(q_2)*cos(q_3) + q_1d*q_3d*cos(q_2)*sin(q_3) + q_1d*q_3d*cos(q_3)*sin(q_2)))/20 - (3841*q_1dd*cos(q_2))/5000 + (sin(q_4)*(q_1dd*cos(q_2)*sin(q_3) + q_1dd*cos(q_3)*sin(q_2) - q_1d*q_3d*sin(q_2)*sin(q_3) + q_1d*q_3d*cos(q_2)*cos(q_3)))/20 + (167*((11*q_2d)/25 + (11*q_3d)/25)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/100 + (167*(cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)) + sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))*((5*q_2d)/167 + (5*q_3d)/167 + (5*q_4d)/167))/100 + (q_4d*cos(q_4)*(q_1d*cos(q_2)*sin(q_3) + q_1d*cos(q_3)*sin(q_2)))/20 + (q_4d*sin(q_4)*(q_1d*cos(q_2)*cos(q_3) - q_1d*sin(q_2)*sin(q_3)))/20 - (1837*q_1dd*cos(q_2)*cos(q_3))/2500 + (1837*q_1dd*sin(q_2)*sin(q_3))/2500 + (167*q_1d*sin(q_2)*((23*q_2d)/50 + (3*q_1d*sin(q_2))/50))/100 + (1837*q_1d*q_3d*cos(q_2)*sin(q_3))/2500 + (1837*q_1d*q_3d*cos(q_3)*sin(q_2))/2500];
f5=f4;
rW2ToolEdge=[2*P_T(1); P_T(1); 0]; % in the wrist frame
n5=n4-cross(rW2ToolEdge,f5);
end